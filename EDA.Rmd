---
title: "EDA"
author: "Team!"
date: "4/18/2020"
output: html_document
---

```{r warning = F, message = F}
# Clean up R environment
rm(list = ls())

# Load in packages
library(tidyverse) # Data wrangling, ggplot, etc.
library(knitr)     # This is to make pretty tables (see kable() )
library(corrplot)  # Correlation plot 
library(caret)

# Read in data
Raw_data <- 
  read.csv("./Data/training_set_features.csv", stringsAsFactors=FALSE,
           na.strings=c("","NA")) # Account for blanks being NA
Raw_labels <- 
  read.csv("./Data/training_set_labels.csv", stringsAsFactors=FALSE)
Raw_test <- 
  read.csv("./Data/test_set_features.csv", stringsAsFactors=FALSE)

# Global options
set.seed(14)
theme_set(theme_bw()) # Set a better ggplot theme
options(digits=3)     # Set digits to 3 to avoid too many values
```


# Data Cleaning

Join the response variables (in Raw_labels) to the training data (Raw_data)
```{r}
# Since the datasets are in the same order, I just cbind() the two, dropping
#  respondent id in the Raw_labels dataset
Training_full <- cbind(Raw_data, Raw_labels[2:3])
```


Check the total number of NAs for each row. Note that `health_insurance`, `employment_industry`, and `employment_occupation` have a LOT of NAs.  

```{r}
# Total number of NAs
sapply(Training_full, function(x) sum(is.na(x)))

# For a prettier table format in pdf/html
#kable(sapply(wiki, function(x) sum(is.na(x))), col.names = 'NA Values')
```

Since `health_insurance`, `employment_industry`, and `employment_occupation` have almost half data missing, it might make sense to not include these 3 variables as our potential predictors.

```{r}
# Remove the 3 variables with almost half missing data

training <- 
  Training_full %>% 
  dplyr::select(-health_insurance,-employment_industry,-employment_occupation)

```

# General EDA
Basic exploration of the data. 

It seems like roughly half of the training observations were vaccinated for the flu, while only ~21% were vaccinated for the h1n1 
```{r}
# Examine how may of the total observations were vaccinated
Raw_labels %>%
  summarize(seasonal_vaccine = sum(seasonal_vaccine), 
            h1n1_vaccinated = sum(h1n1_vaccine), 
            n = n())
```

In addition to the 2 response variables, we also have 32 potential predictors (not including respondent IDs and the 3 variables from above with huge number of NAs). Out of these, 12 are demographic variables. Let's first look at these demographic variables.

```{r,fig.height=8}

training %>%
  dplyr::select(age_group:household_children)%>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_bar()+
    ggtitle("Frequencies of demographic variables in the training dataset")+
    theme(text = element_text(size=12), axis.text.x = element_text(angle=45, hjust=1))
```

From the plot above, we can see that the distribution of data by age group is not skewed (almost uniform) so we have enough data from each age group. The census_msa plot shows that most of our respondents live in a metropolitan statistical area (MSA) as defined by the US Census, with only about 6000 in Non-MSA.

Based on the education plot, it looks like most of our respondents have at least some college education. We do have 1407 missing education values though.

We can also see that most of our respondents are either employed or not in the labor force. Respondents not in the labor force are not employed and have stopped looking for work. Only a small number of respondents are unemployed and looking for a job. We also have 1463 missing values here.

Even though our data doesn't specify the name of the geographical region, it looks like we have decent representation from all 10 geographical regions.

The household variables suggest that most of the respondents live in a household either by themselves or with one other adult. Most of the respondents also have no children in the household. It might make sense to combine household_children and household_adults to create the total household size.

The income data suggests that most respondents are above poverty with a sizeable chunk making over 75,000 USD per year. However, we have 4423 missing values, which may be a sizeable chunk for our prediction purposes.

The respondents are about equally distributed based on marital status. Our sample is also overwhelmingly white with very few participants from other races. As such, our findings may not be applicable to general population.

In addition to the above information, the plots also show that most of our respondents own their home. We can also see that we have more female respondents than male.

Next, we can look at the other potential predictors and their distributions.

```{r,fig.height=8, fig.width=16}

training %>%
  dplyr::select(h1n1_concern:opinion_seas_sick_from_vacc)%>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_bar()+
    ggtitle("Frequencies of non-demographic variables in the training dataset")+
    theme(text = element_text(size=12), axis.text.x = element_text(angle=45, hjust=1))

```

Let's also look at the correlation matrix for these 20 non-demographic predictors.

```{r,fig.height=8, fig.width=16}

#nondemocorr <- 
#  cor(as.matrix(dplyr::select(training,h1n1_concern:opinion_seas_sick_from_vacc)), 
#      method=c("spearman"), use="pairwise.complete.obs")

nondemocorr <- 
  training %>%
  dplyr::select(h1n1_concern:opinion_seas_sick_from_vacc) %>%
  as.matrix() %>%
  cor(method=c("spearman"), use="pairwise.complete.obs")

corrplot(nondemocorr, method="number", number.cex = .7)

```


It looks like behavioral variables seem to be positively correlated with each other. It might be possible to reduce the number of variables if we combine the behavioral variables together such that this new variable will indicate the number of safe behaviors a respondent adhered to. A "behavioral" variable could just add variables from behavioral_antiviral_meds to behavioral_touch_face.

Similarly, the opinion variables also seem to go together. We can potentially combine these as well. Also, doctor_recc_h1n1 and doctor_recc_seasonal, which represent whether the respondent's doctor recommended h1n1 or seasonal vaccine, also seem to be strongly positively correlated.


```{r}
training %>%
  dplyr::select(behavioral_antiviral_meds:behavioral_touch_face) %>%
  mutate(safe_behaviors=rowSums(.,na.rm=FALSE))%>%
  ggplot(aes(x=safe_behaviors))+
  geom_bar()

newvariable1 <- training %>%
  dplyr::select(behavioral_antiviral_meds:behavioral_touch_face) %>%
  mutate(safe_behaviors=rowSums(.,na.rm=TRUE))%>%
  dplyr::select(-behavioral_antiviral_meds:-behavioral_touch_face)

training$safe_behaviors <- newvariable1$safe_behaviors

training <- training %>% select(-behavioral_antiviral_meds:-behavioral_touch_face)
```

It looks like this newly created variable is pretty normally distributed. We have to note that this new variable will use 0 instead of NA. 561 rows would be removed if we use na.rm=FALSE.

Now we can split the dataset for modeling purposes.

```{r}
# Remove all NAs
trainingwithoutNA = na.omit(training)

# Create internal training and testing sets
set.seed(56)
train_index = createDataPartition(paste(trainingwithoutNA$seasonal_vaccine, trainingwithoutNA$h1n1_vaccine, sep = ""), p = 0.60, list=FALSE)
model_train = trainingwithoutNA[train_index,]
model_test =  trainingwithoutNA[-train_index,]
```


---

Checking relationship predictors have with the response

It seems that those in the older age group tend to get the seasonal vaccine
```{r,fig.height=8, fig.cap='Seasonal Vaccine Rates by Age Group'}
vac_plot <-
  training %>%
  mutate(seasonal_vaccine = ifelse(seasonal_vaccine == 1, 'Yes', 'No'),
         h1n1_vaccine = ifelse(seasonal_vaccine == 1, 'Yes', 'No'))


vac_plot %>%
  group_by(age_group, seasonal_vaccine) %>%
  tally() %>%
  ggplot(aes(x = age_group, y = n, fill = seasonal_vaccine)) +
    geom_bar(position="fill", stat="identity") +
    ggtitle("Seasonal Vaccine Rates by Age Group") +
    theme(text = element_text(size=12), axis.text.x = element_text(angle=45, hjust=1))
```









---

### Below is experimental

I'm not sure if we want to go this route but behavioral variables are probably going to be important for both h1n1_vaccine and seasonal_vaccine response variables.


```{r,fig.height=8,width=16}

summary(glm(seasonal_vaccine~safe_behaviors,data=training,family="binomial"))

summary(glm(h1n1_vaccine~safe_behaviors,data=training,family="binomial"))

```

### Clustering

```{r}
#For clustering, everything has to be numeric. I also created a column to combine the 2x2 vaccine outcome conditions was just one variable.
All_numeric <- 
  read.csv("./Data/All Numbers.csv", stringsAsFactors=FALSE,
           na.strings=c("","NA"))

Num.withoutNA = na.omit(All_numeric)

set.seed(120) #Hierarchical clustering
hc.out <- hclust(dist(Num.withoutNA), method="average")
plot(hc.out)
hc.clusters <- cutree(hc.out,4) #Since there's 4 vaccine options, this seemed like a logical cut
table(hc.clusters, Num.withoutNA$vaccine) #Clustering doesn't seem to give us any meaningful division by which vaccine participants either did or did not get.
set.seed(130) #K-means clustering
num.km <- within(Num.withoutNA, rm(vaccine))
km.out=kmeans(num.km,4,nstart=20)
km.clusters=km.out$cluster
table(km.clusters)
table(km.clusters,hc.clusters) #There is a good level of overlap in the way the two methods clustered, for example Cluster 2 with K-means is almost completely the same as Cluster 4 from the Hierarchical clustering.

```
Unfortunitally, clustering does not appear to work with this dataset well.  Splitting the data into 4 clusters (the number of levels the outcome variable has) does not cluster participants well according to whether or not they got either of the vaccines.
